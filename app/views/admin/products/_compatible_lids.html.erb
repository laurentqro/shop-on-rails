<%# Compatible Lids Section - For Cup Products %>
<%# This form is separate from the main product form to avoid nested form issues %>
<div class="collapse collapse-arrow border border-neutral rounded-md mt-8">
  <input type="checkbox" id="compatible-lids-collapse" />
  <div class="collapse-title text-xl font-medium">
    Compatible Lids
    <span class="badge badge-sm ml-2"><%= product.compatible_lids.count %> lids</span>
  </div>
  <div class="collapse-content">
    <fieldset class="fieldset">
      <p class="text-sm text-base-content/70 mb-4">
        Select which lid products are compatible with this cup. Check all lids that fit this cup, and select one as the default (recommended) option.
      </p>

      <%
        # Get all lid products
        all_lids = Product.where("LOWER(name) LIKE ?", "%lid%")
                         .where.not(id: product.id)
                         .order(:name)
        current_lid_ids = product.compatible_lids.pluck(:id)
        default_lid_id = product.product_compatible_lids.find_by(default: true)&.compatible_lid_id
      %>

      <%= form_with url: update_compatible_lids_admin_product_path(product), method: :patch, local: true do |f| %>
        <% if all_lids.empty? %>
          <p class="text-sm text-base-content/60">
            No lid products found. Create lid products first.
          </p>
        <% else %>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-6">
            <% all_lids.each do |lid| %>
              <label class="flex items-start gap-3 p-3 border border-base-300 rounded-lg cursor-pointer hover:bg-base-200 transition-colors">
                <%= check_box_tag 'lid_ids[]', lid.id, current_lid_ids.include?(lid.id), class: "checkbox checkbox-primary mt-1", id: "lid_#{lid.id}" %>
                <div class="flex-1">
                  <div class="font-medium"><%= lid.name %></div>
                  <div class="text-sm text-base-content/60">
                    <%= pluralize(lid.active_variants.count, 'variant') %>
                  </div>
                </div>
                <% if current_lid_ids.include?(lid.id) %>
                  <label class="flex items-center gap-1 text-sm">
                    <%= radio_button_tag 'default_lid_id', lid.id, default_lid_id == lid.id, class: "radio radio-primary radio-sm" %>
                    <span class="text-xs text-base-content/60">Default</span>
                  </label>
                <% end %>
              </label>
            <% end %>
          </div>

          <%= f.submit "Save Compatible Lids", class: "btn btn-primary" %>
        <% end %>
      <% end %>
    </fieldset>
  </div>
</div>
