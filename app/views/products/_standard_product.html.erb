<% unless @selected_variant %>
  <div class="container mx-auto px-4 py-8">
    <div class="alert alert-warning">
      <span>This product is currently unavailable.</span>
    </div>
    <%= link_to "Back to Products", products_path, class: "btn btn-primary mt-4" %>
  </div>
  <% return %>
<% end %>

<% content_for :title do %>
<%= @product.name %> | <%= @product.category.name %> | Afida
<% end %>

<% content_for :meta_description do %>
<%= @product.description %>
<% end %>

<% content_for :head do %>
  <!-- Twitter Card meta tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="<%= @product.name %>">
  <meta name="twitter:description" content="<%= @product.description %>">
  <% image_source = @selected_variant&.product_photo&.attached? ? @selected_variant.product_photo : @product.product_photo %>
  <% if image_source&.attached? %>
    <meta name="twitter:image" content="<%= polymorphic_url(image_source.variant(resize_to_limit: [1200, 630])) %>">
  <% end %>

  <!-- Open Graph meta tags (also used by Twitter and WhatsApp) -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="<%= @product.name %>">
  <meta property="og:description" content="<%= @product.description %>">
  <meta property="og:url" content="<%= polymorphic_url(@product) %>">
  <meta property="og:site_name" content="Afida">
  <% if image_source&.attached? %>
    <meta property="og:image" itemprop="image" content="<%= polymorphic_url(image_source.variant(resize_to_limit: [800, 600], format: :jpg, quality: 85).processed) %>">
    <meta property="og:image:width" content="800">
    <meta property="og:image:height" content="600">
    <meta property="og:image:type" content="image/jpeg">
    <meta property="og:image:alt" content="<%= @product.name %>">
  <% end %>
  <% if @selected_variant %>
    <meta property="product:price:amount" content="<%= @selected_variant.price %>">
    <meta property="product:price:currency" content="GBP">
  <% end %>

  <script type="application/ld+json">
    <%= raw product_structured_data(@product, @selected_variant) %>
  </script>

  <script type="application/ld+json">
    <%= raw breadcrumb_structured_data([
      { name: "Home", url: root_url },
      { name: @product.category.name, url: category_url(@product.category) },
      { name: @product.name, url: product_url(@product) }
    ]) %>
  </script>
<% end %>

<% content_for :breadcrumbs do %>
  <%= render "shared/breadcrumbs", product: @product %>
<% end %>

<div class="drawer drawer-end">
  <input id="cart-drawer" type="checkbox" class="drawer-toggle" />
  <div class="drawer-content">
    <div class="container mx-auto py-8 min-h-screen">
      <div class="card lg:card-side bg-base-100 shadow-sm">
        <figure class="lg:w-1/2">
          <% image_source = @selected_variant&.product_photo&.attached? ? @selected_variant.product_photo : @product.product_photo %>
          <% if image_source&.attached? %>
            <%= image_tag image_source.variant(resize_to_limit: [400, 400]), alt: @product.name %>
          <% else %>
            <div class="w-full h-full bg-gray-200 rounded-lg shadow-md flex items-center justify-center">
              <span class="text-gray-500">Image not available</span>
            </div>
          <% end %>
        </figure>

        <div class="card-body lg:w-1/2"
             data-controller="product-options"
             data-product-options-variants-value="<%= @variants_json.to_json %>"
             data-product-options-pac-size-value="<%= @selected_variant.pac_size || 1 %>">
          <h2 class="card-title text-3xl lg:text-4xl">
            <%= @product.name %>
          </h2>

          <p class="text-xl text-black mt-2" data-product-options-target="unitPriceDisplay">
            <%= number_to_currency(@selected_variant.price) %> / pack
          </p>

          <% if @product.colour.present? %>
            <span class="text-base-content/60 font-medium text-lg"><%= @product.colour %></span>
          <% end %>

          <p class="text-base-content/70 my-4">
            <%= @product.description %>
          </p>

          <% if @product.active_variants.count > 1 %>
            <div class="space-y-4 my-4">

              <% @product_options.each do |option| %>
                <div class="w-full">
                  <label class="label pb-2">
                    <span class="label-text font-semibold"><%= option.name %></span>
                  </label>
                  <%
                    # Get unique values for this option from all variants
                    option_values = @product.active_variants.map { |v| v.option_values[option.name] }.compact.uniq
                    # Sort by numeric value (extract numbers from strings like "8oz", "12oz")
                    option_values = option_values.sort_by { |v| v.scan(/\d+/).first.to_i }
                    selected_value = @selected_variant.option_values[option.name]
                    target_name = option.name.downcase
                  %>
                  <div class="flex flex-wrap gap-2">
                    <% option_values.each do |value| %>
                      <button type="button"
                              class="relative bg-white border-2 border-gray-300 text-black hover:border-primary rounded-lg px-6 py-3 cursor-pointer font-medium"
                              data-product-options-target="<%= target_name %>Button"
                              data-value="<%= value %>"
                              data-action="click->product-options#select<%= option.name.capitalize %>">
                        <%= value %>
                        <span class="option-checkmark hidden absolute -top-2 -right-2 w-6 h-6 bg-primary rounded-full flex items-center justify-center">
                          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-white" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                          </svg>
                        </span>
                      </button>
                    <% end %>
                  </div>
                </div>
              <% end %>
            </div>
          <% end %>

          <%
            pac_size = @selected_variant.pac_size || 1
            min_qty = pac_size
            max_qty = pac_size * 10
            # Generate quantity options as multiples of pack size
            quantity_options = (1..10).map { |i| pac_size * i }
          %>
          <div class="card-actions space-y-3 my-4">
            <%= form_with url: cart_cart_items_path, method: :post, class: "w-full space-y-3", local: false, data: { controller: "cart-drawer", action: "turbo:submit-end->cart-drawer#open" } do |f| %>
              <input type="hidden"
                     name="cart_item[variant_sku]"
                     value="<%= @selected_variant.sku %>"
                     data-product-options-target="variantSkuInput" />

              <div class="form-control">
                <label class="label">
                  <span class="label-text font-semibold">Select quantity:</span>
                </label>
                <%= select_tag "cart_item[quantity]",
                              options_for_select(quantity_options.map { |q| ["#{q / pac_size} #{(q / pac_size) == 1 ? 'pack' : 'packs'} (#{number_with_delimiter(q)} units)", q] }, pac_size),
                              class: "select select-bordered select-lg w-full",
                              data: { product_options_target: "quantitySelect", action: "change->product-options#updateQuantity" } %>
              </div>

              <div class="my-8 space-y-3">
                <div class="flex items-center gap-2 text-secondary">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                  </svg>
                  <span class="font-medium">Delivered in 2 to 3 working days</span>
                </div>
                <div class="mt-8 grid grid-cols-[1fr_auto] gap-4 items-start">
                  <div>
                    <p class="text-lg">Total (excl. VAT)</p>
                    <p class="text-xs text-base-content/60">Free delivery on all mainland UK orders over Â£100 excl. VAT</p>
                  </div>
                  <p class="text-2xl font-semibold whitespace-nowrap text-right" data-product-options-target="priceDisplay">
                    <%= number_to_currency(@selected_variant.price) %>
                  </p>
                </div>
              </div>

              <%= f.submit "Add to basket", class: "btn btn-primary btn-lg w-full" %>
            <% end %>
          </div>

          <% if @selected_variant.variant_attributes.any? %>
            <div class="overflow-x-auto rounded-box border border-base-content/5 bg-base-100">
              <table class="table table-zebra table-pin-cols">
                <thead>
                  <tr>
                    <th colspan="2" class="bg-base-200 font-medium">Specifications</th>
                   </thead>
                <tbody>
                <% @selected_variant.variant_attributes.each do |key, value| %>
                  <tr>
                    <td class="font-semibold"><%= key.to_s.humanize %></td>
                    <td><%= value %></td>
                  </tr>
                <% end %>
              </table>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <div class="drawer-side">
    <label for="cart-drawer" aria-label="close sidebar" class="drawer-overlay"></label>
    <ul class="menu bg-base-200 text-base-content min-h-full w-80 p-4">
      <%= render "shared/drawer_cart_content" %>
    </ul>
  </div>
</div>
