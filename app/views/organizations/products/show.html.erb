<div class="container mx-auto px-4 py-8">
  <%= link_to "â† Back to Your Products", organizations_products_path, class: "btn btn-ghost mb-4" %>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    <!-- Product Image -->
    <div>
      <% if @product.product_photo.attached? %>
        <%= image_tag @product.product_photo.variant(resize_to_limit: [800, 800]),
                      alt: @product.name,
                      class: "w-full rounded-lg shadow-lg" %>
      <% else %>
        <div class="bg-base-200 w-full aspect-square rounded-lg flex items-center justify-center">
          <span class="text-6xl">ðŸ“¦</span>
        </div>
      <% end %>
    </div>

    <!-- Product Details & Reorder -->
    <div class="space-y-6">
      <div>
        <h1 class="text-3xl font-bold"><%= @product.name %></h1>
        <p class="text-lg text-gray-600 mt-2">Your custom branded product</p>
      </div>

      <!-- Configuration Details -->
      <div class="card bg-base-200">
        <div class="card-body">
          <h3 class="card-title">Product Specifications</h3>
          <dl class="space-y-2">
            <% if @product.configuration_data["size"] %>
              <div class="flex justify-between">
                <dt class="text-gray-600">Size:</dt>
                <dd class="font-semibold"><%= @product.configuration_data["size"] %></dd>
              </div>
            <% end %>
            <% if @product.configuration_data["type"] %>
              <div class="flex justify-between">
                <dt class="text-gray-600">Type:</dt>
                <dd class="font-semibold"><%= @product.configuration_data["type"].titleize %></dd>
              </div>
            <% end %>
            <% if @product.active_variants.first %>
              <div class="flex justify-between">
                <dt class="text-gray-600">SKU:</dt>
                <dd class="font-semibold"><%= @product.active_variants.first.sku %></dd>
              </div>
              <div class="flex justify-between">
                <dt class="text-gray-600">Available Stock:</dt>
                <dd class="font-semibold text-primary"><%= number_with_delimiter(@product.active_variants.first.stock_quantity) %> units</dd>
              </div>
            <% end %>
          </dl>
        </div>
      </div>

      <!-- Reorder Form -->
      <% if @product.active_variants.first %>
        <% variant = @product.active_variants.first %>
        <%
          min_order = 500
          available_stock = variant.stock_quantity
          # Generate quantity options from 500 to available stock (or max 10000), in 500 increments
          max_qty = [available_stock, 10000].min
          quantity_options = (min_order..max_qty).step(500).to_a
          quantity_options << available_stock if available_stock > min_order && !quantity_options.include?(available_stock)
          quantity_options.sort!
        %>
        <%= form_with url: cart_cart_items_path, method: :post, class: "space-y-4", local: false do |f| %>
          <%= hidden_field_tag "cart_item[variant_sku]", variant.sku %>

          <div class="form-control">
            <label class="label">
              <span class="label-text font-semibold">Quantity (units)</span>
            </label>
            <%= select_tag "cart_item[quantity]",
                          options_for_select(quantity_options.map { |q| [number_with_delimiter(q), q] }, 1000),
                          class: "select select-bordered w-full" %>
            <label class="label">
              <span class="label-text-alt">Minimum order: <%= number_with_delimiter(min_order) %> units | Available: <%= number_with_delimiter(available_stock) %> units</span>
            </label>
          </div>

          <div class="card bg-base-200">
            <div class="card-body">
              <div class="flex justify-between text-lg">
                <span class="font-semibold">Price per unit:</span>
                <span class="text-primary font-bold">Â£<%= number_with_precision(variant.price, precision: 2) %></span>
              </div>
            </div>
          </div>

          <%= f.submit "Add to Cart", class: "btn btn-primary btn-lg w-full cursor-pointer" %>
        <% end %>
      <% else %>
        <div class="alert alert-warning">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
          </svg>
          <span>This product is currently out of stock. Please contact us to restock.</span>
        </div>
      <% end %>
    </div>
  </div>
</div>
